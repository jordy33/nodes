<!-- templates/node_editor.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyUI-like Node Editor</title>
    <!-- Rete.js dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rete/1.4.4/rete.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rete-connection-plugin/0.9.0/connection-plugin.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rete-vue-render-plugin/0.5.1/vue-render-plugin.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.14/vue.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #node-editor {
            width: 100%;
            height: 100vh;
            background-color: #2b2b2b;
        }
        .node {
            background: #333;
            border-radius: 10px;
            cursor: pointer;
            min-width: 180px;
            height: auto;
            padding: 10px;
            color: white;
            border: 2px solid #666;
        }
        .node:hover {
            border-color: #999;
        }
        .node .title {
            background: #444;
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .socket {
            width: 16px;
            height: 16px;
            border-radius: 8px;
            background: #666;
            cursor: pointer;
        }
        .socket:hover {
            background: #999;
        }
        .connection {
            stroke: #fff;
            stroke-width: 2px;
        }
        .input-control {
            padding: 5px;
        }
        .input-control input {
            width: 60px;
            background: #444;
            border: 1px solid #666;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="node-editor"></div>
    
    <script>
        class SquareComponent extends Rete.Component {
            constructor() {
                super("Square");
                this.data.component = 'square';
            }

            builder(node) {
                const input = new Rete.Input('value', 'Value', numSocket);
                const output = new Rete.Output('result', 'Result', numSocket);
                const ctrl = new NumControl(this.editor, 'value');

                return node
                    .addInput(input)
                    .addControl(ctrl)
                    .addOutput(output);
            }

            worker(node, inputs, outputs) {
                const value = node.data.value || 0;
                const squared = value * value;
                outputs['result'] = squared;
                
                // Send calculation to server
                fetch('/process_node', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        node_id: node.id,
                        value: value
                    })
                })
                .then(response => response.json())
                .then(data => {
                    outputs['result'] = data.result;
                    this.editor.trigger('process');
                });
            }
        }

        class NumControl extends Rete.Control {
            constructor(emitter, key, readonly = false) {
                super(key);
                this.emitter = emitter;
                this.key = key;
                this.template = `<input type="number" :readonly="readonly" :value="value" @input="change($event)"/>`;
                this.scope = {
                    value: 0,
                    readonly,
                    change: this.change.bind(this)
                };
            }

            change(e) {
                this.scope.value = +e.target.value;
                this.update();
                this.emitter.trigger('process');
            }

            update() {
                if (this.key)
                    this.putData(this.key, this.scope.value);
            }
        }

        // Initialize the editor
        const container = document.querySelector('#node-editor');
        const editor = new Rete.NodeEditor('demo@0.1.0', container);
        const engine = new Rete.Engine('demo@0.1.0');
        
        const numSocket = new Rete.Socket('Number');
        
        // Add components
        const squareComponent = new SquareComponent();
        editor.register(squareComponent);
        engine.register(squareComponent);

        // Add plugins
        editor.use(ConnectionPlugin.default);
        editor.use(VueRenderPlugin.default);    

        // Create initial node
        async function initEditor() {
            const node = await squareComponent.createNode();
            node.position = [80, 200];
            editor.addNode(node);
            
            editor.on('process nodecreated noderemoved connectioncreated connectionremoved', async () => {
                await engine.abort();
                await engine.process(editor.toJSON());
            });
        }

        initEditor().catch(console.error);

        // Enable node creation on right-click
        container.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const mousePosition = [e.offsetX, e.offsetY];
            squareComponent.createNode().then(node => {
                node.position = mousePosition;
                editor.addNode(node);
            });
        });
    </script>
</body>
</html>
